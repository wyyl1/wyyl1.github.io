---
title: "故事"
date: 2022-08-09T00:00:02+08:00
draft: true
tags: ["TDD","极客时间"]
categories: ["学习笔记"]
---

## 一个价值几十万的符号

大家好，我是 aoe（发音是汉语拼音），是一名普通的 Java 程序员。日常工作中会接触到一些和财务相关的业务，完成此类工作时一直都特别小心谨慎，生怕出错。工作很多年，一直风平浪静，直到有一天运营部门的同事告诉我管理后台显示打给用户的金额比正常情况多了几十万！故事是这样的：我们公司的产品是一款语聊 App，聊天室内用户赠送给主播礼物，主播收到礼物后可以获得报酬 = 礼物价值 ✖️ **主播分成比例**。本次的需求是根据主播评级动态获取**主播分成比例**。正常逻辑是先从 Redis 获取，如果 Redis 中没有再从数据库获取，如果数据库中也没有就返回一个默认值并保存至  Redis。问题就出在默认值，正常情况下**主播分成比例**应该小于 100%，但由于我的失误，返回了一个无意义的值 -1，在计算主播收益时
所有参与运算的数据都**取绝对值**后再运算，这样 -1 就变成了 1，**主播分成比例**变成了 100%。当财务部门给主播结算报酬时发现要多出几十万，往日不起眼的小 Bug 瞬间升级成了重大 Bug，幸亏发现及时才没有造成更大损失。

## 反思

修复 Bug 就是一瞬间的事，-1 改成 0.6 就完事了，但今后如何避免类似的问题再次发生，又是一个难题。从上面的例子开始反思，发现几个问题：1、认真的工作也会写出 Bug；2、通过 Debug、日志、逐行看代码排错太耗费时间；3、Code review时自己很难找出自己的 Bug。

## 摸索着学 TDD

关于上述问题，我首先想到的是通过单元测试解决，因为听过 TDD 的传说，所以就开始了自学。首先在网上搜索一些视频，看看大家是怎么用 TDD 开发的，但是大部分都只有简单的几步：先写一个测试，运行一下没有通过，接下来实现被测功能，再运行一些测试，通过。刚开始接触的时候感觉好厉害，但看的多了感觉有点不对：红-绿-重构，视频中都是到绿就结束了！还是看书靠谱。

我先跟着《Java测试驱动开发》、《测试驱动开发的艺术》两本书练习，同时在项目中使用 TDD。起初思考怎么写测试会占用大部分开发时间，相对于之前的进度也慢了不少。经过一段时间的实践与思考，找出了存在的问题：1、方法内包含了太多功能，违反了单一原则，所以导致构造测试非常困难。初学者可以将一个方法的代码控制在 10 行，一般来说可以很轻松的构造出该方法的测试用例。如果这样还不能解决问题，请直接浏览文末学习清单。2、无脑的复制粘贴操作总是想阻止重构操作，想着每天让代码好一点，总有一天都会好起来，咬咬牙开始重构。3、和身边的同事、朋友分享通过 TDD 能让重构落地的实践时，大家要么摇头说听不懂，要么说时间紧，哪有时间写测试。难道“代码能跑就不要动”这句话是对的？有时也会有疑惑：我真的是在进行 TDD 吗？TDD 是我这样的吗？怎么不像传说中那么神奇？

## 突然出现一扇门

正当我四处寻找如何提升 TDD 技能的方法时，《徐昊 · TDD 项目实战 70 讲》为我打开了系统学习这么技术的大门！

看了 01 课的视频演示后，我被 8X 老师通过 Idea 进行一波又一波的重构操作惊呆了，第一次知道还有这么多强大的功能！仅仅看到 04 课后，不仅有接连不断的震惊，更意外的接触到了极限编程的气息！此时我光环加身，看完视频按自己的想法实现，总以为到最后结果和老师的会一样。01 到 03 课每次都差那么一点，但还是可以跟着老师的思路继续开发，但是到了 04 课，老师一波神操作，我彻底懵了！就是几个小细节我和老师的代码已经是初级与神级的区别了……第一次跟着写代码翻车了。但也收获了几个口诀：happy path（测试正常功能）；sad path（测试异常功能）；default path（测试默认值）。

有了前车之鉴，进入“实战项目二｜RESTful开发框架”的学习后，我都是照着视频敲代码的，以为这样就没事了？这只是幻觉。有时我颠倒了上下行的代码顺序、有时我将代码放在了循环外或者循环内（和老师不一样的地方），通过解决这些问题当你以为我对解答问题的思路有进一步了解时，你错了！我只是单纯的靠蛮力发现了代码哪里不一样（就像之前有一个游戏：大家来找茬）。当你以为这样我会一无所获并浪费时间时，其实我以体会到 inLine、提取方法、提取变量（局部、方法参数、类变量）这些常用的重构手法，并已经能熟练的运用在日常开发中。另一个收获：工作中真正需要的是功能测试，而不是刻板的单元测试。例如一个方法中包含数据库的更新操作，按书中单元测试的要求“是不能依赖外部数据库，需要通过 Mock 代替”，而功能测试则更更加关注执行结果，重点验证执行结果是否达到预期，至于是否连接数据库没有限制。我也曾经用 Mock 代替数据库的更新操作，单元测试都通过，但上线后依然出了 Bug，原因是 SQL 写错了，之后我便不那么刻意追求单元测试，而是更有效的功能测试。

进入“实战项目三｜RESTful Web Services (32讲)”的学习没多久后就开始偷懒没有跟着写代码了，对解题思路也是一知半解，不过也收获了 JUnit5 中通过 DynamicTest 简化测试的技能。视频中老师将百行左右代码缩减到了几十行，工作中我将上千甚至上万行测试代码缩减到了几十行，解决了一个之前不可能完成的功能测试。

## 惊喜不断的读者交流群

虽然课程中评论区留言不活跃，但读者交流群中时不时会掀起一波又一波打破我认知的讨论，还时不时出现过几位平易近人的大佬解答群友提问。分享几个字少但感觉很有道理的讨论给大家。

超级巨头曾经的结论：结对编程 + TDD 大约会增加 15-20% 的成本；但是提高70%的代码质量，减少反攻和上线时间。
大佬说：自动化重构工具的效率极度影响开发效率。
小巨人项目：打基础用的，入职第一年需要看完的书 [点击查看共 28 本](https://www.wyyl1.com/post/19/xjr.png)；核心技能要深挖，TDD；每天看书俩小时，TDD 8 小时。
tw有没做技术洞察的方法论可以学习下的么：技术洞察很容易啊，过去15年所有重要文献读一遍；然后不明白的，自己试。很容易就洞察了；有哪些重要文献？找一本最近出的书，连书带参考文献，看一遍；参考文献的参考文献；然后继续，直到都看完，不就知道了。肯定漏不掉。
仪式：TDD，愿人们都尊你的名为圣，愿你的国降临，愿你的旨意行在产品测试，如同行在开发。我们日用的测试，今天赐给我们，免了我们的技术债，如同我们免了人的债，不叫我们遇到恐惧，救我们脱离凶恶。因为国度、权柄、荣耀，全是你的，直到永远，阿们。

## 小结

这门课程是把《重构 改善既有代码的设计（第2版）》这本书拍成了电视剧，学习之后可以做到 8X 老师在这本书中的赞誉里提到的“先做对，再做好”，使用这种思路极大的简化问题。如果你不想看书，可以尝试一下看电视剧。

## 学习清单

- 《Head First 设计模式》、《代码整洁之道》、《修改代码的艺术》、《重构》
- 《Java测试驱动开发》、《测试驱动开发的艺术》
- 王争老师的专栏《设计模式之美》
- 郑烨老师的四个专栏：《软件设计之美》、《代码之丑》、《10x程序员工作法》、《程序员的测试课》
- [读者交流群学习笔记](https://www.wyyl1.com/post/19/wq/)