---
title: "故事"
date: 2022-04-16T00:00:02+08:00
draft: true
tags: ["TDD","极客时间"]
categories: ["学习笔记"]
---

  我是一名 Java 程序员，多年以来对自己的代码自信满满，虽然有很多 Bug，但是修修补补又活力满满！我会在涉及到金钱相关的
业务时，认真编写测试代码，为资金流保驾护航！就这样，岁月静好：玩游戏、追剧、看电影、听小说、和同事谈笑风生，无忧无虑……
突然有一天，运营部门告诉我：钱算错了！本期打款业务全部冻结，需要尽快修复数据，避免让用户觉得我们公司要跑路了！

  从白天到黑夜，我在测试环境运行了一次又一次测试，Debug 分支无数，又加了一波测试，再加了一波测试场景，完全没问题啊！
第二天上午，依然在测试环境里寻找线索，但一无所获！离下一期打款时间越来越近，修复数据的时间不多了！此刻，已惊动了老板亲自找 Bug。
下午，老板通读业务代码终于定位到了 Bug！

## 清奇的 Bug

### 业务场景简介（做了精简加工处理）

- 产品：我们是一款语聊 App，聊天室内用户赠送给主播礼物，主播收到礼物后可以获得报酬（礼物价值 ✖️ **主播分成比例**）。
- 起因：**主播分成比例**使用**读取数据库字段**的方式，代替原来**读取 yaml 文件**的方式
  - 评级越高，**主播分成比例**越高，促进主播积极性
  - 根据用户评级，获取个**人分成比例**
  - **人分成比例**不能超过 90%（仅用于举例，不是真实业务取值） 🍄 隐含约定

### Bug 描述

- 1、从 Redis 中获取评级对应的**主播分成比例**
- 2、如果 Redis 中没有，则从数据库中获取
- 3、如果数据库中也没有，则使用默认值
  - ❌ 这里我返回了无意义的值：-1
- 4、**主播分成比例**只有在管理后台**新增/编辑**时才会被缓存到 Redis
- 5、测试环境中，**主播分成比例**是测试的一部分，所以都**新增/编辑**过，所以测试环境一直正常❗️
  - ❌ 生产环境中，管理后台没有对**主播分成比例**进行操作，大家都以为读取默认值
- 6、获取**主播分成比例**的方法
  - null 则返回默认值
  - 0 则返回默认值
  - -1 则返回默认值 ❌ 我忘写了这个逻辑
- 7、计算主播收益时，所有参与运算的数据都**取绝对值**后再运算
  - ❌  |-1| = 1，主播分成比例变成了 100%

### Bug 导致的损失

- 如果未发现 Bug，一波打款操作将损失**好几十万**
- 公司信誉度下降
- 我忐忑不安、通宵修复数据、吓坏了

### Bug 经验总结

- 1、参与交易运算的方法初始值需要设置为有意义的值
- 2、参与**资金转出**金额计算的方法需要有**单元测试**（覆盖全部逻辑分支）保证计算结果正确
- 3、邀请其他Java开发者、测试部门审核单元测试代码
- 4、每次项目发布前运行必须执行的单元测试，测试通过后再发布
- 5、增加**对账**功能，及时发现问题

## 关于加班

### 追忆我曾经加过的班

- 下班了，别人没走，我也不好意思走
- 反正要加班，先放松一下，等几分钟后开始写代码，然后很多个几分钟过去了，又发现放松是多么愉悦啊……
- 时间紧任务重，大家都在努力，千万不要拖后腿
- 半夜，醒醒，线上出 Bug 了，开始胆战心惊的找 Bug
- 正在办公桌前噼里啪啦写代码时，总会被打断
  - 开会了
  - 测试丢过来一个 Bug，要求尽快解决
  - 运营丢过来一个 Bug，要求尽快解决
  - 很久之后找到了 Bug，修复还要很久
- 需求理解错了，改
- 需求变更了，改
- 添加一个新功能，工程量巨大
- 接触陌生项目，每一次改动都要先理解现有的逻辑

### 怎样减少加班

  有的只要合理规划时间、加强自律就可以避免，相对容易，但收效可能不如预期。最好的方法是：遗留系统现代化！

> “没有测试的代码都是遗留代码” —— 《修改代码的艺术》作者 Michael Feathers

## 写测试很难

[《开篇词｜你现在所写的每一行代码，都是未来的遗留系统》](https://time.geekbang.org/column/article/505735)灵魂三问：

> - 你的代码有测试吗？
> - 你平时开发新需求时会写测试吗？
> - 你在修改 bug 时会补测试吗？

  写一个方法的测试简单，但要做到灵魂三问的要求，那是相当的难！分享一下我学习写测试的经验：