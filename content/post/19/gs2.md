---
title: "故事"
date: 2022-06-12T00:00:02+08:00
draft: true
tags: ["TDD","极客时间"]
categories: ["学习笔记"]
---

## 一个价值几十万的符号

大家好，我是 aoe（读音是汉语拼音），是一名普通的 Java 程序员。日常工作中会接触到一些和财务相关的业务，完成此类工作时一直都特别小心，生怕出错。工作很多年，一直风平浪静，直到有一天运营部门的同事告诉我系统计算出的打给用户的金额有误，好像多了几十万！听到这个消息，我先是一惊，但很快就淡定下来，心里暗想：系统昨天刚上线，今天就出了 Bug ，让测试的同事在测试环境复现一下 Bug，我多打印点日志，不就可以解决了吗？接下来奇怪的事情发生了，测试环境无论实验哪种场景计算结果都是正常的！不能复现问题就不能通过 Debug、日志排错，经过进一步分析得出新的结论“测试与生产环境的配置不同”，但又找不出哪里不同，无奈之下只能把相关的代码一行一行看下去，寻找 Bug。我们的业务代码比 Spring 源码调用链还长，而且还不停的垮服务调用，时不时还通过发送/订阅消息触发相关逻辑。面对同事和自己写的老代码 + 自己写的新代码，不一会儿就头晕眼花，查找速度越来越慢。尤其是在看到自己代码时，总容易被强烈的自信心驱使，自己的代码怎么可能有错，而迅速跳过，努力查找同事的 Bug。正因如此，十几小时后我写的 Bug 被同事发现了。原因是：新的需求是用户分成比例可以根据不同级别从管理后台动态配置，如果还没来得急配置就取默认值。测试环境为了方便测试，我给每个所有用户级别都添加了默认值，所以没测出问题。生产环境上，因为我没有权限操作管理后台，所有配置都没有默认值。而最终问题就出在默认值我随意给了一个-1，参数效验时，验证了用户分成比例不能大于80%，所以这步通过了，接下来可怕的事情发生了，最终计算结果时是取 -1 的绝对值后在进行计算的，这样 -1 就变成了 1，用户分成比例变成了 100%。

## 反思

修复 Bug 就是一瞬间的事，-1 改成 0.6 就完事了，但今后如何避免类似的问题再次发生，又是一个难题。从上面的例子可以看出几个问题：1、认真信心的工作也会写出 Bug；2、通过 Debug、日志、逐行看代码排错太耗费时间；3、复查时自己很难找出自己的 Bug。关于这些问题，我起初和大家想的差不多，通过单元测试解决，于是就学习了 TDD。在学习的过程中发现，真正需要的是功能测试，而不是刻板的单元测试。例如一个方法中包含数据库的更新操作，按书中单元测试的要求“是不能依赖外部数据库，需要通过 Mock 代替”，而功能测试则更更加关注执行结果，重点验证执行结果是否达到预期，至于是否连接数据库没有限制。顺便说一下，我也曾经用 Mock 代替数据库的更新操作，单元测试都通过，但上线后依然出了 Bug，原因是 SQL 写错了，之后我便不那么可以追求单元测试，而是更有效的功能测试。

## 有了 TDD 就高枕无忧了吗？

我们公司的项目已经开发了 5 年多，大部分功能可以满足日常需要，有很大一部分新功能都是基于现有功能改造，修修补补就上线。

## 为什么会关注遗留系统

故事是这样的：我们公司的产品是一款语聊 App，聊天室内用户赠送给主播礼物，主播收到礼物后可以获得报酬 = 礼物价值 ✖️ **主播分成比例**。本次的需求是根据主播评级动态获取**主播分成比例**。正常逻辑是先从 Redis 获取，
如果 Redis 中没有再从数据库获取，如果数据库中也没有就返回一个默认值并保存至  Redis。问题就出在默认值，正常情况下**主播分成比例**应该小于 100%，但由于我的失误，返回了一个无意义的值 -1，在计算主播收益时
所有参与运算的数据都**取绝对值**后再运算，这样 -1 就变成了 1，**主播分成比例**变成了 100%。当财务部门给主播结算报酬时发现要多出几十万，往日不起眼的小 Bug 瞬间升级成了重大 Bug，幸亏发现及时才没有造成更大损失。

这次事件为我敲响了警钟，也开始认真思考如何避免类似问题再次发生，当时的解决方案是：新业务、老系统修改关键业务时引入 TDD ，缩短发现 Bug 的时间，提高代码质量，发现问题时可以及时重构。在此十分感谢公司包容的管理模式，
允许我在开发中尝试 TDD。当时还不知道这就是属于遗留系统现代化，回想起来还真是“万事开头难，开头后更难”。

## 遗留系统现代化实战

第一步：先跟着《Java测试驱动开发》、《测试驱动开发的艺术》两本书练习，同时在项目中使用 TDD。起初思考怎么写测试会占用大部分开发时间，相对于之前的进度也慢了不少。经过一段时间的实践与思考，找出了存在的问题：1、方法
内包含了太多功能，违反了单一原则，所以导致构造测试非常困难。初学者可以将一个方法的代码控制在 10 行，一般来说可以很轻松的构造出该方法的测试用例。如果这样还不能解决问题，分享一下我的学习经验供你参考。郑烨老师的四个专栏
《软件设计之美》、《代码之丑》、《10x程序员工作法》、《程序员的测试课》；王争老师的专栏《设计模式之美》；徐昊老师的专栏《徐昊 · TDD项目实战70讲》；《Head First 设计模式》、《代码整洁之道》、《修改代码的艺术》、《重构》。

第二步：降低核心业务的认知负载。项目中大量使用消息队列驱动业务，虽然降低了耦合性，但极大提高了认知负载。例如使用 SkyWalking 追踪送礼物接口，得到的调用链长度是 300+，业务逻辑一眼望不到尽头。面对这样的庞然大物我先根据数据
流经的系统画出相关系统之间的关系图；然后在分别进入各个系统，探索具体的实现细节，遇到复杂的逻辑梳理出流程图，有效的降低了认知负载。另一种是针对第三方支付的业务特点，提取出了公共接口、合并了相同逻辑的操作。例如每个支付接口都可以通过 HTTPS 请求发起，所以发起请求、保存请求参数和返回结果、接收第三方回调这些操作全部由基类统一处理；不同支付平台对接时只需要按各自要求转换请求参数，解析返回结果、回调数据，就可以完成对接。

第三步：通过植物绞杀模式改造老接口。分享一下如何改造调用链 300+ 送礼物接口。该业务横跨 8 个系统，每个系统中大部分方法的功能都是纠缠不清，很难编写测试，所以干脆新开了一个项目针对遗留系统的接口进行功能测试。这样的好处是测试代码
可以合理规划功能模块，摆脱遗留代码的束缚；编写测试相关代码时可以保持愉悦的心情，因为写的是现代化的代码。测试代码主要记录送礼前后赠送人、受赠人在不同系统的状态（例如钱包余额、礼物数量、亲密度等），再结合送礼的数量和价格验证数据是否正确。有了完整的功能测试做保障后，就可以随心所欲的改造老接口，只要每个功能点改动后立即运行一下测试就能知道结果，顺利替换老接口。

## 现代化带来的好处

最大的好处是排查线上 Bug 的时间越来越少，大部分 Bug 都在 TDD 阶段被解决，而且可以快速定位问题，不但提升了代码质量，还提升了开发效率。同时也拓展了知识面，学到了很多新知识。

## 总结

掌握 TDD 是遗留系统现代化的基础，推荐从 TDD 开启实战。
