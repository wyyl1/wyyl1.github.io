---
title: "DDD ä»£ç ä¸‰"
date: 2024-04-21T00:00:01+08:00
draft: false
tags: ["DDD","æå®¢æ—¶é—´"]
categories: ["æ‰‹æŠŠæ‰‹æ•™ä½ è½åœ° DDD","å­¦ä¹ ç¬”è®°"]
---

> [DDD å­¦ä¹ ç¬”è®° | æå®¢æ—¶é—´ | æ‰‹æŠŠæ‰‹æ•™ä½ è½åœ° DDD](../dir)

[ğŸ† åŸæ–‡ï¼š12ï½œä»£ç å®ç°ï¼ˆä¸‹ï¼‰ï¼šæ€æ ·æ›´åŠ â€œé¢å‘å¯¹è±¡â€ï¼Ÿ](http://gk.link/a/12kkd)

## ä½¿ç”¨è¡¨æ ¼ä¸ä¸šåŠ¡æ–¹ç¡®è®¤éœ€æ±‚ç®€å•æ˜äº†

| å±æ€§ | åˆ›å»º | ä¿®æ”¹ | å¤‡æ³¨ |
| --- | --- | --- | --- |
| ç»„ç»‡ ID | - | ï¼Ÿ | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹ |
| ç§Ÿæˆ· | æ˜¯ | ï¼Ÿ | æ“ä½œä¸èƒ½è·¨ç§Ÿæˆ·ï¼Œå› æ­¤ä¸å¯æ›´æ”¹ï¼Œä½†éœ€è¦ä½œä¸ºåç»­æ“ä½œçš„è¾“å…¥å‚æ•° |

## æ›´æ–°ã€å–æ¶ˆæ“ä½œå¯ä»¥æ”¾åœ¨ Handler é¢†åŸŸæœåŠ¡ä¸­

```java
package chapter12.unjuanable.domain.orgmng.org;
// imports...

@Component
public class OrgHandler {
    private final CommonValidator commonValidator;
    private final OrgNameValidator nameValidator;
    private final OrgLeaderValidator leaderValidator;
    private CancelOrgValidator cancelValidator;

    public OrgHandler(CommonValidator commonValidator
            , OrgNameValidator nameValidator
            , OrgLeaderValidator leaderValidator
            , CancelOrgValidator cancelValidator) {
        // ä¸ºä¾èµ–æ³¨å…¥èµ‹å€¼...
    }

    public void updateBasic(Org org, String newName
                , Long newLeader, Long userId) {
        updateName(org, newName);
        updateLeader(org, newLeader);
        updateAuditInfo(org, userId);
    }

    public void cancel(Org org, Long userId) {
        cancelValidator.cancelledOrgShouldNotHasEmp(org.getTenant()
                        , org.getId());
        cancelValidator.OnlyEffectiveOrgCanBeCancelled(org);
        org.setStatus(OrgStatus.CANCELLED);
        updateAuditInfo(org, userId);
    }

    private void updateLeader(Org org, Long newLeader) {
        if (newLeader != null && !newLeader.equals(org.getLeader())) {
            leaderValidator.leaderShouldBeEffective(org.getTenant()
                                , newLeader);
            org.setLeader(newLeader);
        }
    }

    private void updateName(Org org, String newName) {
        if (newName != null && !newName.equals(org.getName())) {
            nameValidator.orgNameShouldNotEmpty(newName);
            nameValidator.nameShouldNotDuplicatedInSameSuperior(
                  org.getTenant(), org.getSuperior(), newName);
            org.setName(newName);
        }
    }

    private void updateAuditInfo(Org org, Long userId) {
        // è®¾ç½®æœ€åä¿®æ”¹äººå’Œæ—¶é—´
    }
}
```

## æé«˜åº”ç”¨ API çš„å°è£…æ€§

- **æœ€å°æ¥å£åŸåˆ™ï¼Œç›®çš„æ˜¯å‡å°æ¨¡å—é—´çš„è€¦åˆï¼Œæé«˜ç¨‹åºçš„å¯ç»´æŠ¤æ€§**
- **è¦ä¸ºæ¯ä¸ªåŠŸèƒ½ç¼–å†™å•ç‹¬çš„å‚æ•° DTOï¼ŒåªåŒ…å«å¿…è¦çš„å‚æ•°**

æ·»åŠ ç»„ç»‡çš„ JSON å‚æ•°ä¿®æ”¹å‰

```json
{
  "createdAt": "2022-10-05T06:49:39.659Z",
  "createdBy": 0,
  "id": 0,
  "lastUpdatedAt": "2022-10-05T06:49:39.659Z",
  "lastUpdatedBy": 0,
  "leader": 0,
  "name": "string",
  "orgType": "string",
  "status": "string",
  "superior": 0,
  "tenant": 0
}
```

æ·»åŠ ç»„ç»‡çš„ JSON å‚æ•°ä¿®æ”¹å

```json
{
  "leader": 0,
  "name": "string",
  "orgType": "string",
  "superior": 0,
  "tenant": 0
}
```

## é€šè¿‡â€œè¡¨æ„æ¥å£â€æé«˜å°è£…æ€§

```java
package chapter12.unjuanable.domain.orgmng.org;
// imports ...

@Component
public class OrgHandler {
    //...
    
    public void cancel(Org org, Long userId) {
        cancelValidator.OrgToBeCancelledShouldNotHasEmp(
                                    org.getTenantId(), org.getId());
        cancelValidator.OrgToBeCancelledShouldBeEffective(org);
        org.setStatus(OrgStatus.CANCELLED); // ç›´æ¥ä¸º Status èµ‹å€¼
        updateAuditInfo(org, userId);
    }
    
    // ...
}
```

å…¶ä¸­ï¼Œorg.setStatus(OrgStatus.CANCELLED) ç›´æ¥å°†ç»„ç»‡çš„çŠ¶æ€è®¾ç½®æˆäº†â€œå·²æ’¤é”€â€ã€‚ä»é¢å‘å¯¹è±¡çš„è§’åº¦æ¥çœ‹ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ Org ç±»æä¾›ä¸€ä¸ª cancel() æ–¹æ³•ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š

```java
package chapter12.unjuanable.domain.orgmng.org;

public class Org {
    
    //Org è‡ªå·±ç®¡ç†è‡ªå·±çš„çŠ¶æ€
    public void cancel() { 
        this.status = OrgStatus.CANCELLED;
    }
}
```

è¿™æ ·ï¼ŒOrg ç±»å°±å¯ä»¥è‡ªå·±ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼ŒOrgHandler å°±ä¸å¿…äº†è§£ Org å†…éƒ¨çŠ¶æ€çš„è½¬æ¢ç»†èŠ‚ï¼Œåªéœ€å‘Šè¯‰ Org éœ€è¦æ’¤é”€å°±å¯ä»¥äº†ï¼Œåƒä¸‹é¢è¿™æ ·ã€‚

```java
package chapter12.unjuanable.domain.orgmng.org;

@Component
public class OrgHandler {
    
    public void cancel(Org org, Long userId) {
        cancelValidator.OrgToBeCancelledShouldNotHasEmp(
                        org.getTenant(), org.getId());
        cancelValidator.OrgToBeCancelledShouldBeEffective(org);
        org.cancel();   // åªéœ€å‘Šè¯‰ Org è¦è¿›è¡Œæ’¤é”€ï¼Œä½†ä¸å¿…äº†è§£ Org å†…éƒ¨ç»†èŠ‚
        updateAuditInfo(org, userId);
    }
}
```

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹â€œåªæœ‰æœ‰æ•ˆçš„ç»„ç»‡æ‰èƒ½è¢«æ’¤é”€â€è¿™æ¡è§„åˆ™çš„å®ç°ä»£ç ã€‚

```java
package chapter12.unjuanable.domain.orgmng.org.validator;

@Component
public class CancelOrgValidator {
    // åªæœ‰æœ‰æ•ˆçš„ç»„ç»‡æ‰èƒ½è¢«æ’¤é”€
    public void OnlyEffectiveOrgCanBeCancelled(Org org) {
        //ç›´æ¥è®¿é—®äº†çŠ¶æ€å±æ€§
        if (!org.getStatus().equals(OrgStatus.EFFECTIVE)) { 
            throw new BusinessException("è¯¥ç»„ç»‡ä¸æ˜¯æœ‰æ•ˆçŠ¶æ€ï¼Œä¸èƒ½æ’¤é”€ï¼");
        }
    }
}
```


æˆ‘ä»¬çœ‹åˆ° CancelOrgValidator ç›´æ¥è®¿é—®äº† Org çš„çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆç»„ç»‡ã€‚è¿™å®é™…ä¸Šåˆæ˜¯é‡æ„ä¸­çš„ä¸€ç§åå‘³é“ï¼Œå«åš**ç‰¹æ€§ä¾æ‹ï¼ˆFeature Envyï¼‰**ã€‚Status è¿™ä¸ªç‰¹æ€§æ˜¯å±äº Org ç±»çš„ï¼Œè€Œ CancelOrgValidator è¦é€šè¿‡è®¿é—®è¿™ä¸ªç‰¹æ€§æ¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼Œæ‰€ä»¥ CancelOrgValidator â€œä¾æ‹â€äº† Org çš„ç‰¹æ€§ã€‚è¿™æ˜¯å¯¹è±¡å°è£…æ€§è¢«ç ´åçš„å¾å…†ã€‚

**è§£å†³æ–¹æ³•æ˜¯å°†è¿™æ®µåˆ¤æ–­é€»è¾‘ç§»åŠ¨åˆ° Org ç±»å†…éƒ¨**ï¼Œé‡æ„åçš„ Org ç±»æ˜¯è¿™æ ·çš„ã€‚

```java
package chapter12.unjuanable.domain.orgmng.org;

public class Org {
    public boolean isEffective() {
        return status.equals(OrgStatus.EFFECTIVE);
    }
}
```

è¿™æ ·ï¼ŒCancelOrgValidator å°±å¯ä»¥ä¸ä¾èµ– Org çš„å†…éƒ¨çŠ¶æ€äº†ã€‚

```java
package chapter12.unjuanable.domain.orgmng.org.validator;

@Component
public class CancelOrgValidator {

    // åªæœ‰æœ‰æ•ˆçš„ç»„ç»‡æ‰èƒ½è¢«æ’¤é”€
    public void OnlyEffectiveOrgCanBeCancelled(Org org) {
        //ä¸å†ä¾èµ– Org çš„å†…éƒ¨çŠ¶æ€
        if (!org.isEffective()) { 
            throw new BusinessException("è¯¥ç»„ç»‡ä¸æ˜¯æœ‰æ•ˆçŠ¶æ€ï¼Œä¸èƒ½æ’¤é”€ï¼");
        }
    }
}
```

Org.cancel() å’Œ Org.isEffective() æ—¢æé«˜äº†å¯¹è±¡çš„å°è£…æ€§ï¼Œä¹Ÿè¡¨è¾¾äº†è¿™ä¸ªåŠŸèƒ½çš„ä¸šåŠ¡å«ä¹‰ï¼Œå› æ­¤ä¹Ÿæ˜¯**è¡¨æ„æ¥å£**æ¨¡å¼çš„ä¸€ç§åº”ç”¨ã€‚